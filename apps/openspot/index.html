<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>빈방 알리미 등록 1139</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <div class="flex-1 flex flex-col justify-center items-center p-6">
            <div class="w-full max-w-md space-y-8">
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-900">빈방 알리미 등록</h2>
                    <p class="mt-2 text-gray-600">원하시는 날짜와 펜션을 등록해주세요</p>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">날짜 선택</label>
                            <input type="text" id="datepicker" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="날짜를 선택해주세요">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">예약 URL</label>
                            <input type="text" id="bookingUrl" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="booking.ddnayo.com 주소를 입력해주세요">
                            <p class="mt-2 text-sm text-gray-500">예약하고 싶은 펜션/캠핑장의 예약 페이지 주소를 입력해주세요</p>
                        </div>

                        <button id="confirmBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-medium hover:bg-blue-700 transition duration-200">
                            알리미 등록하기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.onload = function () {
            // URL 파라미터 가져오기
            var urlParams = new URLSearchParams(window.location.search);
            var userId = urlParams.get("user_id") || "";
            var botUserKey = urlParams.get("botUserKey") || "";
            var plusfriendUserKey = urlParams.get("plusfriendUserKey") || "";

            console.log("URL 파라미터:", { userId, botUserKey, plusfriendUserKey });

            // Flatpickr 초기화
            flatpickr("#datepicker", {
                dateFormat: "Y-m-d",
                defaultDate: new Date(),
                minDate: "today"
            });

            // 예약 URL 기본값
            document.getElementById("bookingUrl").value = "https://booking.ddnayo.com/sample";

            // 등록 버튼 이벤트
            document.getElementById("confirmBtn").addEventListener("click", function () {
                var selectedDate = document.getElementById("datepicker").value;
                var bookingUrl = document.getElementById("bookingUrl").value;

                if (!selectedDate) {
                    alert("날짜를 선택해주세요.");
                    return;
                }

                var urlPattern = new RegExp("^https:\\/\\/booking\\.ddnayo\\.com\\/.+");
                if (!urlPattern.test(bookingUrl)) {
                    alert("올바른 예약 URL을 입력해주세요.");
                    return;
                }

                var payload = {
                    user_id: userId,
                    date: selectedDate,
                    url: bookingUrl,
                    botUserKey: botUserKey,
                    plusfriendUserKey: plusfriendUserKey
                };

                console.log("전송할 데이터:", payload);

                fetch('https://dp56rnbwf9.execute-api.ap-northeast-2.amazonaws.com/prod/booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    let responseBody = typeof data.body === "string" ? JSON.parse(data.body) : data.body;
                    if (responseBody.success) {
                        alert("알리미가 정상적으로 등록되었습니다!");
                        window.location.href = "kakaotalk://inappbrowser/close";
                    } else {
                        alert(responseBody.message || "등록에 실패했습니다. 다시 시도해주세요.");
                    }
                })
                .catch(error => {
                    console.error('서버 오류:', error);
                    alert("서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
                });
            });
        };
    </script>
</body>
</html>
