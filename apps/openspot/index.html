<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카카오톡 예약 시스템</title>

    <!-- 1038 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Flatpickr (날짜 선택 라이브러리) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- 카카오 SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-6">
    <div id="loginSection" class="bg-white shadow-lg rounded-lg p-8 max-w-lg w-full text-center">
        <h1 class="text-2xl font-semibold text-gray-900 mb-6">카카오 로그인</h1>
        <p class="text-gray-700 mb-4">예약을 진행하려면 먼저 로그인하세요.</p>
        <button id="kakaoLoginBtn" class="w-full bg-yellow-500 text-black py-3 rounded-lg font-medium hover:bg-yellow-600 transition">
            카카오 로그인
        </button>
    </div>

    <div id="reservationSection" class="bg-white shadow-lg rounded-lg p-8 max-w-lg w-full hidden">
        <h1 class="text-2xl font-semibold text-gray-900 mb-6">예약 정보를 입력하세요</h1>

        <div class="mb-4 text-gray-700 break-all">
            <span class="font-medium">사용자 ID: </span> 
            <span id="userId" class="text-blue-600"></span>
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">날짜 선택</label>
            <input type="text" id="datepicker" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="날짜를 선택하세요 (YYYY-MM-DD)">
        </div>

        <div class="mb-6">
            <label class="block text-gray-700 font-medium mb-2">예약 URL</label>
            <input type="text" id="bookingUrl" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="https://booking.ddnayo.com/예약페이지">
        </div>

        <button id="confirmBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">
            예약하기
        </button>
    </div>

    <script>
        Kakao.init('7f93a2b4c8c9e3d1d2a7f43c8f8b5a1c'); // ✅ 실제 카카오 앱 키로 설정

        function checkLoginStatus() {
            Kakao.Auth.getStatusInfo(({ status, user }) => {
                if (status === 'connected') {
                    console.log("✅ 로그인 유지됨");
                    localStorage.setItem("kakaoAccessToken", Kakao.Auth.getAccessToken());
                    document.getElementById("loginSection").classList.add("hidden");
                    document.getElementById("reservationSection").classList.remove("hidden");
                    document.getElementById("userId").textContent = user.id;
                } else {
                    console.log("❌ 로그인 필요");
                }
            });
        }

        document.getElementById("kakaoLoginBtn").addEventListener("click", function () {
            Kakao.Auth.login({
                success: function (authObj) {
                    console.log("✅ 로그인 성공", authObj);
                    localStorage.setItem("kakaoAccessToken", authObj.access_token);
                    checkLoginStatus();
                },
                fail: function (err) {
                    console.error("❌ 로그인 실패", err);
                }
            });
        });

        window.onload = function () {
            checkLoginStatus();
        };

        document.getElementById("confirmBtn").addEventListener("click", function () {
            var selectedDate = document.getElementById("datepicker").value;
            var bookingUrl = document.getElementById("bookingUrl").value;
            var accessToken = localStorage.getItem("kakaoAccessToken");

            var payload = {
                user_id: document.getElementById("userId").textContent,
                date: selectedDate,
                url: bookingUrl,
                accessToken: accessToken
            };

            fetch('https://your_lambda_endpoint/booking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "kakaotalk://inappbrowser/close";
                } else {
                    alert('❌ 예약 실패: ' + data.message);
                }
            })
            .catch(error => console.error('❌ 서버 오류 발생:', error));
        });
    </script>
</body>
</html>
