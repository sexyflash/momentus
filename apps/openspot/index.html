<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>날짜 & 예약 URL 입력</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Flatpickr (달력 라이브러리) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- 카카오 SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-6">

    <div class="bg-white shadow-lg rounded-lg p-8 max-w-lg w-full">
        <h1 class="text-2xl font-semibold text-gray-900 mb-6">예약 정보를 입력하세요</h1>

        <!-- 사용자 ID 표시 -->
        <div class="mb-4 text-gray-700">
            <span class="font-medium">사용자 ID:</span> <span id="userId" class="text-blue-600"></span>
        </div>

        <!-- 날짜 입력 -->
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">날짜 선택</label>
            <input type="text" id="datepicker" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="날짜를 선택하세요">
            <p id="dateError" class="text-red-500 text-sm mt-2 hidden">날짜를 선택해주세요.</p>
        </div>

        <!-- URL 입력 -->
        <div class="mb-6">
            <label class="block text-gray-700 font-medium mb-2">예약 URL</label>
            <input type="text" id="bookingUrl" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="booking.ddnayo.com 로 시작하는 주소 전체를 입력하세요.">
            <p id="urlError" class="text-red-500 text-sm mt-2 hidden">주소를 확인하세요. 현재 <strong>ddnayo.com</strong>만 지원합니다.</p>
        </div>

        <!-- 확인 버튼 -->
        <button id="confirmBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">선택 완료</button>
    </div>

    <script>
        Kakao.init('4e75fc983042984d1af886aad148d76c'); // 카카오 키 설정
    
        // URL에서 user_id 가져오기
        var urlParams = new URLSearchParams(window.location.search);
        var userId = urlParams.get("user_id");
        if (!userId) {
            alert("카카오톡에서 다시 실행해주세요.");
            window.location.href = "kakaotalk://inappbrowser/close";
        }
        document.getElementById("userId").innerText = userId;
    
        // Flatpickr 달력 설정
        flatpickr("#datepicker", {
            dateFormat: "Y-m-d",
            minDate: "today", 
            defaultDate: "today",
        });
    
        document.getElementById("confirmBtn").addEventListener("click", function() {
            var selectedDate = document.getElementById("datepicker").value;
            var bookingUrl = document.getElementById("bookingUrl").value;
            var dateError = document.getElementById("dateError");
            var urlError = document.getElementById("urlError");
    
            dateError.classList.add("hidden");
            urlError.classList.add("hidden");
    
            if (!selectedDate) {
                dateError.classList.remove("hidden");
                return;
            }
    
            var urlPattern = /^https:\/\/booking\.ddnayo\.com\/.+/;
            if (!urlPattern.test(bookingUrl)) {
                urlError.classList.remove("hidden");
                return;
            }
    
            fetch('https://dp56rnbwf9.execute-api.ap-northeast-2.amazonaws.com/prod/booking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: selectedDate, url: bookingUrl, user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Kakao.API.request({
                        url: '/v2/api/talk/memo/default/send',
                        method: 'POST',
                        headers: { Authorization: `Bearer ${data.kakao_token}` },
                        data: { template_object: { object_type: 'text', text: "예약이 완료되었습니다!" } }
                    });
                    window.location.href = "kakaotalk://inappbrowser/close";
                } else {
                    alert('예약 실패: ' + data.message);
                }
            })
            .catch(error => { console.error('Error:', error); alert('서버 오류 발생'); });
        });
    </script>



</body>
</html>
