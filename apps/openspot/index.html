<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>날짜 & 예약 URL 입력</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Flatpickr (달력 라이브러리) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- 카카오 SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-6">

    <div class="bg-white shadow-lg rounded-lg p-8 max-w-lg w-full">
        <h1 class="text-2xl font-semibold text-gray-900 mb-6">예약 정보를 입력하세요</h1>

        <!-- 사용자 ID 표시 -->
        <div class="mb-4 text-gray-700 break-all">
            <span class="font-medium">사용자 ID:</span> <span id="userId" class="text-blue-600"></span>
        </div>

        <!-- 날짜 입력 -->
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">날짜 선택</label>
            <input type="text" id="datepicker" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="날짜를 선택하세요 (YYYY-MM-DD)">
            <p id="dateError" class="text-red-500 text-sm mt-2 hidden">날짜를 선택해주세요.</p>
        </div>

        <!-- URL 입력 -->
        <div class="mb-6">
            <label class="block text-gray-700 font-medium mb-2">예약 URL</label>
            <input type="text" id="bookingUrl" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="booking.ddnayo.com 로 시작하는 주소 전체를 입력하세요.">
            <p id="urlError" class="text-red-500 text-sm mt-2 hidden">주소를 확인하세요. 현재 <strong>ddnayo.com</strong>만 지원합니다.</p>
        </div>

        <!-- 확인 버튼 -->
        <button id="confirmBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">선택 완료</button>
    </div>

    <script>
        // 카카오 JS SDK 초기화 (앱키 필요 시 설정)
        Kakao.init('YOUR_KAKAO_APP_KEY');

        // URL 파라미터에서 user_id, botUserKey, plusfriendUserKey 등 가져오기
        var urlParams = new URLSearchParams(window.location.search);
        var userId              = urlParams.get("user_id") || "";
        var botUserKey          = urlParams.get("botUserKey") || "";
        var plusfriendUserKey   = urlParams.get("plusfriendUserKey") || "";

        // 너무 긴 userId는 일부만 보이도록 처리
        function shortenId(id) {
            if (id.length <= 15) return id;
            return id.slice(0, 10) + "..." + id.slice(-5);
        }

        // 사용자 ID 표시 (짧게)
        var userIdSpan = document.getElementById("userId");
        userIdSpan.textContent = shortenId(userId);

        // 날짜, 예약 URL을 테스트용으로 미리 채워놓기
        var datePicker = document.getElementById("datepicker");
        var bookingUrlInput = document.getElementById("bookingUrl");

        // Flatpickr 달력 설정
        flatpickr("#datepicker", {
            dateFormat: "Y-m-d",
            // 예: 오늘 날짜가 기본값으로
            defaultDate: new Date(),
            minDate: "today"
        });

        // 테스트용 기본값
        bookingUrlInput.value = "https://booking.ddnayo.com/sample";

        // "선택 완료" 버튼 클릭 시
        document.getElementById("confirmBtn").addEventListener("click", function() {
            var selectedDate = datePicker.value;
            var bookingUrl   = bookingUrlInput.value;

            var dateError = document.getElementById("dateError");
            var urlError  = document.getElementById("urlError");

            dateError.classList.add("hidden");
            urlError.classList.add("hidden");

            // 날짜 필수 확인
            if (!selectedDate) {
                dateError.classList.remove("hidden");
                return;
            }

            // ddnayo.com 주소만 체크
            var urlPattern = /^https:\\/\\/booking\\.ddnayo\\.com\\/.+/;
            if (!urlPattern.test(bookingUrl)) {
                urlError.classList.remove("hidden");
                return;
            }

            // 전송할 payload
            var payload = {
                user_id: userId,
                date: selectedDate,
                url: bookingUrl,
                botUserKey: botUserKey,
                plusfriendUserKey: plusfriendUserKey
            };

            // 전송 전에 어떤 데이터가 나가는지 확인 (디버그용)
            console.log("Sending payload to Lambda:", payload);
            alert("전송할 데이터:\n" + JSON.stringify(payload, null, 2));

            // Lambda로 POST
            fetch('https://dp56rnbwf9.execute-api.ap-northeast-2.amazonaws.com/prod/booking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                console.log("Lambda 응답:", data);
                alert("응답 받음:\n" + JSON.stringify(data, null, 2));

                if (data.success) {
                    // 성공 시 메시지
                    alert("예약 완료! 창을 닫습니다.");
                    // 카톡 인앱브라우저 닫기
                    window.location.href = "kakaotalk://inappbrowser/close";
                } else {
                    alert('예약 실패: ' + (data.message || '알 수 없는 오류'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('서버 오류 발생: ' + error);
            });
        });
    </script>
</body>
</html>
